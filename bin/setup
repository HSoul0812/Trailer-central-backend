#!/usr/bin/env bash

set -eu

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

. "$ROOT"/bin/libs/env.sh

rm -Rf laravel-nova-bd32015c9dce9060fe327f09e96abbe729900648 # just in case it exists
unzip nova.zip

cp "${ROOT}"/.env.example "${ROOT}"/.env
cp "${ROOT}"/.env "${ROOT}"/.env.testing

docker-compose down
docker-compose up -d

echo "Waiting for postgres database..."
sleep 6 # this is not elegant, but it works

cli composer install

cli php artisan key:generate

cp "${ROOT}"/.env "${ROOT}"/.env.testing

DB_DATABASE=$(read_env_var "DB_DATABASE" "trailertrader")

sed -i "s/DB_DATABASE=${DB_DATABASE}/DB_DATABASE=${DB_DATABASE}_test/" "${ROOT}"/.env.testing

cli php artisan migrate
cli php artisan nova:publish
cli php artisan optimize
cli php artisan route:clear
